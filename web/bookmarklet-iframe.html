<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Bookmarklet iframe</title>
</head>

<body>
   <script>
      let wikiTab = window.open(window.location.host == 'expitau.github.io' ? 'https://expitau.github.io/InfiniteCraftWiki' : `http://${window.location.host}/web/index.html`);
      
      // Request local storage from bookmarklet on Infinite Craft
      let lastHeartbeat = Date.now();
      setInterval(() => {
         if(Date.now() - lastHeartbeat > 15000){
            window.parent.postMessage('disconnected', 'https://neal.fun')
         } else {
            window.parent.postMessage('requestLocalStorage', 'https://neal.fun')
         }
      }, 500);

      let mainSent = false;
      let isWikiReady = false;
      let isDataReady = false;lastHeartbeat
      let localStorageData = '';
      let saveData = [];
      let lastSaveData = "";

      function sendData(type, data) {
         wikiTab.postMessage(JSON.stringify({type: type, data: data}), `http://${window.location.host}`);
      }

      // Add event listener for reciving local storage from Infinite Craft
      window.addEventListener('message', function (event) {
         if(event.origin == `http://${window.location.host}`){
            lastHeartbeat = Date.now();
            if(event.data == 'ready'){
               isWikiReady = true;
               if(isDataReady){
                  sendData('update all', saveData);
               }
            }
         }
         if(event.origin == 'https://neal.fun'){
            if(event.data === lastSaveData){
               console.log('same save data!');
               sendData('heartbeat', {});
               return;
            }
            fetch(`https://raw.githubusercontent.com/expitau/InfiniteCraftWiki/main/web/data/index.json`)
            .then(res => res.json())
            .then(data => {
               console.log('sending new save data!')
               isDataReady = true;
               if(isWikiReady){
                  let index = Object.fromEntries(Object.entries(data).map(x => [x[1][1], x[0]]));
                  saveData = JSON.parse(event.data).elements.map(a => index[a.text]).filter(x => x);
                  sendData('update all', saveData);
                  lastSaveData = event.data;
               }
            });
         }
      }, false);
   </script>
</body>

</html>